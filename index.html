<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>SkelForm Editor</title>
        <base data-trunk-public-url />
        <style type="text/css">
            :root {
                --color-accent: rgb(65, 46, 105);
                --color-border: rgb(44, 36, 64);
                font-family: Arial;
            }
            :focus {
                outline: none;
            }

            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            .root {
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #2d2c2c;
            }

            .main-canvas {
                display: block;
                z-index: 1;
            }

            .resolution-message {
                display: flex;
                justify-content: center;
                height: 100%;
                align-items: center;
                position: absolute;
                width: 100%;
                z-index: 0;
                color: #d6d6d6;
                text-align: center;
            }

            .file-dialog {
                position: absolute;
                width: 100%;
                height: 100%;
                background: rgb(0, 0, 0, 0.25);
                visibility: hidden;
                z-index: 2;

                .container {
                    position: absolute;
                    width: 100%;
                    height: 100%;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    flex-direction: column;
                }

                .button {
                    color: #d6d6d6;
                    background: var(--color-accent);
                    padding: 5px;
                    border: 2px solid var(--color-border);
                    cursor: pointer;
                }

                input {
                    display: none;
                }
            }
        </style>
    </head>

    <body>
        <div id="image-dialog" class="file-dialog">
            <div class="container">
                <input
                    onchange="toggleFileDialog(false, 'image-dialog'); loadImage(event)"
                    type="file"
                    accept=".png"
                    id="img-input"
                />
                <label class="button" for="img-input">Upload Image</label>
                <label
                    class="button"
                    onclick="toggleFileDialog(false, 'image-dialog')"
                    title="test"
                    >Cancel</label
                >
            </div>
        </div>

        <div id="file-dialog" class="file-dialog">
            <div class="container">
                <input
                    type="file"
                    onchange="toggleFileDialog(false, 'file-dialog'); loadFile(event)"
                    id="file-input"
                />
                <label class="button" for="file-input">Upload File</label>
                <label
                    class="button"
                    onclick="toggleFileDialog(false, 'file-dialog')"
                    >Cancel</label
                >
            </div>
        </div>

        <div
            id="resolution-message"
            class="resolution-message"
            style="visibility: hidden"
        >
            <p>
                If you see this message, SkelForm has not loaded properly.
                <br />
                <br />
                <b>Please refresh the page.</b>
                <br />
                <br />
                If this persists, please adjust the browser zoom level or
                desktop resolution.
            </p>
        </div>

        <link
            data-trunk
            rel="rust"
            href="Cargo.toml"
            data-target-name="SkelForm"
        />
        <div class="root">
            <canvas class="main-canvas" id="canvas"></canvas>
        </div>

        <form></form>

        <img src="" id="last-image" />

        <img src="anim_icons.png" id="img-anim-icons" />

        <script type="module">
            // unused for now
            import * as bindings from "/SkelForm.js";
            window.wasmBindings = bindings;
        </script>

        <script>
            let fileData = [];
            let imgName = "";
            let hasLoaded = false;

            function toggleFileDialog(open, id) {
                let str = open ? "visible" : "hidden";
                document.getElementById(id).style.visibility = str;
            }

            function loadImage(event) {
                var reader = new FileReader();
                reader.readAsDataURL(event.target.files[0]);
                imgName = event.target.files[0].name;
                reader.onload = function (event) {
                    let img = document.getElementById("last-image");
                    img.src = event.target.result;
                };
            }

            async function loadFile(event) {
                const file = event.target.files[0];
                const arrayBuffer = await file.arrayBuffer();
                fileData = new Uint8Array(arrayBuffer);
            }

            function getFile() {
                return fileData;
            }

            function getImgName() {
                return imgName;
            }

            function removeFile() {
                fileData = [];
            }

            function removeImage() {
                document.getElementById("last-image").src = "";
            }

            function resizeCanvas() {
                const canvas = document.getElementById("canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }

            function getCanvasWidth() {
                return canvas.width;
            }
            function getCanvasHeight() {
                return canvas.height;
            }

            function loaded() {
                if (!hasLoaded) {
                    document.getElementById(
                        "resolution-message",
                    ).style.visibility = "visible";
                    hasLoaded = true;
                }
            }

            function downloadZip(binary) {
                var link = document.createElement("a");
                link.href = window.URL.createObjectURL(
                    new Blob([binary], { type: "zip" }),
                );
                link.setAttribute("test", "sk_a");
                link.setAttribute("download", "SkelForm_armature.zip");
                link.click();
                link.remove();
            }

            window.addEventListener("resize", resizeCanvas);
            window.addEventListener("load", resizeCanvas);

            window.onbeforeunload = function () {
                return "";
            };
        </script>
    </body>
</html>
